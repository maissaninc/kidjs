<!DOCTYPE HTML>
<html>
  <head>
    <title>Dominos</title>
    <script src="dist/kid.js"></script>
  </head>
  <body>
    <script type="kidjs">

      import "neural-network"

      let net = neuralNetwork()


      gravity = 0
      friction = 0
      ceiling = false
      floor = false

      let player = rect(width / 2, 50, 100, 20)
      let computer = rect(width / 2, height - 50, 100, 20)
      let interval
      let states

      let ball = circle(width / 2, height / 2, 40)
      function launchBall() {
        let pushX = (random(0, 1) - 0.5) * random(10, 20)
        let pushY = random(-10, 10)
        ball.push(pushX, pushY)

        interval = setInterval(moveComputerPaddle, 1000)
        states = []
      }

      function movePaddle(key) {
        if (key == 'ArrowLeft') {
          player.x = player.x - 10
        }
        if (key == 'ArrowRight') {
          player.x = player.x + 10
        }
      }

      function moveComputerPaddle() {
        wait(0.05)

        let result = net.run([computer.x, ball.x, ball.y, ball.velocity.x, ball.velocity.y]);
        console.log(result);

        // Move left
        let move
        if (result < 0.5) {
          move = -100

        // Move right
        } else {
          move = 100
        }

        states.push({
          input: [computer.x, ball.x, ball.y, ball.velocity.x, ball.velocity.y],
          output: [move]
        })

        // Move paddle, but stay inside bounds
        let newX = computer.x + move
        if (newX < 50) {
          newX = 50
        }
        if (newX > width - 50) {
          newX = width - 50
        }
        computer.moveTo(newX, computer.y)
      }

      on('keydown', movePaddle)
      on('click', launchBall)


      function success() {
        // Train nn
        net.train(states)
      }

      computer.on('collision', success)

      function checkBallPosition() {

        // CPU missed
        if (ball.y > height) {
          console.log('FAILWD')
        }

        // Reset ball
        if (ball.y < 0 || ball.y > height) {
          clearInterval(interval)
          ball.x = width / 2
          ball.y = height / 2
          ball.speed = 0
        }
      }

      ball.on('move', checkBallPosition)



/*
      function placeDomino(x, y) {
        let domino = rect(x, y, 20, 100)
        domino.anchored = false
        domino.bounciness = 0
      }

      for (let x = 200; x < width - 200; x = x + 60) {
        placeDomino(x, 200)
      }
      
      let startX
      let startY
      let marble

      function start() {
        startX = mouseX
        startY = mouseY
        marble = circle(startX, startY, 50)
      }

      function dragging() {
        if (mouseButton) {
          marble.x = mouseX
          marble.y = mouseY
        }
      }

      function release() {
        marble.push(startX - mouseX, startY - mouseY)
      }

      on('mousedown', start)
      on('mousemove', dragging)
      on('mouseup', release)*/

    </script>
  </body>
</html>
